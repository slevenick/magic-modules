def un_parse
  {
<% object.all_user_properties.each do |prop| -%>
    '<%= prop.out_name -%>' => ->(x, _) { x.nil? ? [] : <%= un_parse_code(prop, false) -%> },
<% end # object.all_user_properties.each -%>
  }
end

def dump(path, template_path, test_number, ignored_fields)
  name = '<%= object.name %>'

  arr = un_parse.map do |k, v|
    next if ignored_fields.include?(k)
    v.call(method(k.to_sym).call, k)
  end
  template_vars = {
    name: name,
    arr: arr,
    type: '<%= resource_name(object, product) -%>',
    identifiers: @params,
    number: test_number,
  }
  File.open("#{path}/#{name}_#{test_number}.rb", 'w') do |file|
    file.write(ERB.new(File.read(template_path)).result_with_hash(template_vars))
  end
end